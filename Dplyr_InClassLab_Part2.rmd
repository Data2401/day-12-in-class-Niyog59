---
title: "Intro to dplyr, Part 2 -  Lab"
output: html_document
---

```{r}
library(tidyverse)
```


## Dplyr practice

Install the `"nycflights13"` package. Load (`library()`) the package.
You'll also need to load `tidyverse` The data frame called `flights` should now be accessible to you.


```{r}
# install.packages("nycflights13") # once per computer 
library(nycflights13) # every time you use it
library(tidyverse)

my_flights <- flights ## getting a copy of the data in the environment
```


1. Use functions to inspect it: how many rows and columns does it have? What are the names of the columns? Hint: Use `??flights` to search for documentation on the data set (for what the columns contain)

```{r}
dim(my_flights)
colnames(my_flights)
#The dataset has 336776 rows and 19 columns.  
#Names of columns : "year"           "month"          "day"            "dep_time"       "sched_dep_time" "dep_delay"      "arr_time"       "sched_arr_time" "arr_delay"      "carrier"        "flight"         "tailnum"        "origin"         "dest"           "air_time"     "distance"       "hour"           "minute"         "time_hour"     
```


2. Use `dplyr` to give the dataframe two new columns: `gain = dep_delay - arr_delay` that is the amount of time gained while flying and `speed = distance / air_time * 60`.

New skill: Use `.before = 1` as an argument to `mutate` to add the new variables to the left hand side of the dataset. The . indicates that `.before` is an argument to the function, not the name of a third new variable we are creating. You can use .before or .after to tell R where to put the new variable you've made.


```{r}
my_flights <- my_flights %>%
  mutate(
    gain = dep_delay - arr_delay,
    speed = distance / air_time * 60,
    .before = 1
  )

glimpse(my_flights)

```


3. Use `dplyr` to sort your data frame in descending order by the column you just created. Remember to save this as a variable (or in the same one!)

```{r}
my_flights <- my_flights %>%
  arrange(desc(gain))

head(my_flights)
```

4. If you haven't already, do the last 2 steps in a single statement using the pipe operator. 

```{r}
my_flights <- my_flights %>%
  mutate(
    gain = dep_delay - arr_delay,
    speed = distance / air_time * 60,
    .before = 1
  ) %>%
  arrange(desc(gain))

head(my_flights)

```


5. On average, did flights gain or lose time? Note: use the `na.rm = TRUE` argument to remove NA values from your calc

```{r}
my_flights %>%
  summarise(avg_gain = mean(gain, na.rm = TRUE))

```


6. Create a data.frame of flights with a destination of Hobby Airport (Airport code 'HOU'), only including the origin, destination, and the "made_up_time" column you just created

```{r}
hou_flights <- my_flights %>%
  filter(dest == "HOU") %>%
  select(origin, dest, gain)

head(hou_flights)
```


7. On average, did flights to SeaTac gain or lose time?


```{r}
my_flights %>%
  filter(dest == "SEA") %>%
  summarise(avg_gain = mean(gain, na.rm = TRUE))

```

  
## Exercise: 


Go back to our flights exercise data. Consider flights from JFK to SEA. What was the average, min, and max air time of those flights? Use pipes to answer this question in one statement (without showing any other data)!

```{r}
my_flights %>%
  filter(origin == "JFK", dest == "SEA") %>%
  summarise(
    avg_airtime = mean(air_time, na.rm = TRUE),
    min_airtime = min(air_time, na.rm = TRUE),
    max_airtime = max(air_time, na.rm = TRUE)
  )
```

Consider flights coming into Houston (HOU and IAH). What is the mean arrival delay by departure airport? 

```{r}
my_flights %>%
  filter(dest %in% c("HOU", "IAH")) %>%
  group_by(origin) %>%
  summarise(mean_arr_delay = mean(arr_delay, na.rm = TRUE))

```

Find the flights that are most delayed upon departure from each origin.

```{r}
my_flights %>%
  group_by(origin) %>%
  slice_max(order_by = dep_delay, n = 1, with_ties = FALSE) %>%
  select(origin, dest, dep_delay, everything())

```

Getting ready for next class: look at all the different values for the  airport.

```{r}
my_flights %>%
  distinct(origin)

my_flights %>%
  distinct(dest)

```

Hmm... I don't know about you, but it sure does seem like there are some values here I don't recognize! 


## Lab for the day:


In the package `dplyr` there is a dataset called `starwars`. You'll see this again in the homework (it's just easier to use built-in data!).

```{r}
glimpse(starwars)
```


We're going to use this to practice some data wrangling with `dplyr`. 


How many characters are from each planet?

```{r}
starwars %>%
  count(homeworld)

```

If you wanted to arrange this in descending order, what would you add to the pipe? 

```{r}
starwars %>%
  count(homeworld, sort = TRUE)

```

Find the average height for each eye color. You might find some of the answers to be strange, but keep going! 

```{r}
starwars %>%
  group_by(eye_color) %>%
  summarise(avg_height = mean(height))

```

So.... What's with the NAs? Filter down to just brown eyes find out what's going on. 


```{r}
starwars %>%
  filter(eye_color == "brown") %>%
  select(name, height, eye_color)

```

Okay, so we have missing data here. Try summarising with `na.omit(height)` instead of just `height` or adding `na.rm = T` to the mean function inside summarize. 


```{r}
starwars %>%
  group_by(eye_color) %>%
  summarise(avg_height = mean(height, na.rm = TRUE))

```

So, who is the tallest male? How many blue eyed women are there? How many genders are there? Answer these questions and spend some time asking and answering some of your own. (Or, move to the homework and start working on the questions I ask there!)


```{r}
# Tallest male
starwars %>%
  filter(gender == "male") %>%
  slice_max(height, n = 1, with_ties = FALSE) %>%
  select(name, height)
#Blue-eyed women
starwars %>%
  filter(eye_color == "blue", gender == "female") %>%
  summarise(n = n())
# Genders
starwars %>%
  filter(!is.na(gender)) %>%
  summarise(n_genders = n_distinct(gender))


```
